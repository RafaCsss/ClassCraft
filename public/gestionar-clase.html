<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ClassCraft - Gestionar Clase</title>
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
    <div class="header">
        <div class="header-content container">
            <div class="logo-section">
                <img src="/images/LOGO.png" alt="ClassCraft" class="main-logo" style="max-width: 250px; margin-left: 80px;">
            </div>
            <div class="auth-buttons">
                <button class="btn btn-secondary btn-logout">Cerrar Sesi√≥n</button>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="nav">
            <a href="/dashboard.html">üè† Dashboard</a>
            <a href="/crear-personaje.html" id="navPersonaje">‚öîÔ∏è Mi Personaje</a>
            <a href="/clases.html">üè´ Clases</a>
            <a href="/equipos.html">‚öîÔ∏è Equipos</a>
            <a href="/dev.html">üîß DEV</a>
        </div>

        <div id="cargandoClase" class="card">
            <div class="loading">Cargando informaci√≥n de la clase...</div>
        </div>

        <div id="contenidoClase" class="hidden">
            <!-- Header de la clase -->
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <h2 id="nombreClase">üìö Cargando...</h2>
                        <p><strong>C√≥digo:</strong> <span id="codigoClase" style="background: #667eea; color: white; padding: 4px 12px; border-radius: 4px; font-family: monospace;">...</span></p>
                        <p id="descripcionClase" style="color: #718096;">...</p>
                    </div>
                    <div>
                        <button class="btn btn-secondary" onclick="window.location.href='/dashboard.html'">
                            ‚¨ÖÔ∏è Volver al Dashboard
                        </button>
                    </div>
                </div>
            </div>

            <!-- Stats de la clase -->
            <div class="card">
                <h3>üìä Estad√≠sticas de la Clase</h3>
                <div class="stats-grid">
                    <div class="stat-card">
                        <span class="stat-value" id="totalEstudiantes">0</span>
                        <span class="stat-label">Estudiantes</span>
                    </div>
                    <div class="stat-card">
                        <span class="stat-value" id="totalEquipos">0</span>
                        <span class="stat-label">Equipos</span>
                    </div>
                    <div class="stat-card">
                        <span class="stat-value" id="estudiantesActivos">0</span>
                        <span class="stat-label">Activos Hoy</span>
                    </div>
                    <div class="stat-card">
                        <span class="stat-value" id="promedioNivel">0</span>
                        <span class="stat-label">Nivel Promedio</span>
                    </div>
                </div>
            </div>

            <!-- Vista de equipos y estudiantes -->
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3>üë• Organizaci√≥n de la Clase</h3>
                    <div>
                        <button class="btn btn-info" onclick="toggleVistaEquipos()" id="btnToggleVista">
                            üë• Vista por Equipos
                        </button>
                        <button class="btn btn-success" onclick="verEquiposDeClase()" id="btnEquiposClase">
                            ‚öîÔ∏è Gestionar Equipos
                        </button>
                        <input type="search" id="buscarEstudiante" placeholder="Buscar estudiante..." 
                               style="padding: 8px; border: 1px solid #e2e8f0; border-radius: 4px; margin: 0 10px;">
                        <button class="btn btn-primary" onclick="mostrarAccionesMasivas()">
                            ‚ö° Acciones Masivas
                        </button>
                    </div>
                </div>

                <div id="vistaEquipos" class="hidden">
                    <div id="listaEquipos">
                        <div class="loading">Cargando equipos...</div>
                    </div>
                </div>

                <div id="vistaEstudiantes">
                    <div id="listaEstudiantes">
                        <div class="loading">Cargando estudiantes...</div>
                    </div>
                </div>
            </div>

            <!-- Modal para acciones masivas -->
            <div id="modalAccionesMasivas" class="modal hidden">
                <div class="modal-content">
                    <h3>‚ö° Acciones Masivas</h3>
                    
                    <div class="form-group">
                        <label for="tipoAccionMasiva">Tipo de acci√≥n:</label>
                        <select id="tipoAccionMasiva">
                            <option value="xp">Dar/Quitar XP</option>
                            <option value="salud">Modificar Salud</option>
                            <option value="energia">Modificar Energ√≠a</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="valorAccionMasiva">Valor:</label>
                        <input type="number" id="valorAccionMasiva" placeholder="Ej: 10, -5">
                    </div>

                    <div class="form-group">
                        <label for="razonAccionMasiva">Raz√≥n:</label>
                        <input type="text" id="razonAccionMasiva" placeholder="Ej: Participaci√≥n activa">
                    </div>

                    <div class="form-actions">
                        <button class="btn btn-secondary" onclick="cerrarModalAccionesMasivas()">Cancelar</button>
                        <button class="btn btn-primary" onclick="ejecutarAccionMasiva()">Aplicar a Todos</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="/js/app.js"></script>
    <script>
        // üî• Helper function QUIR√öRGICO para comparar IDs - ANTI-ObjectId
        function compararIds(id1, id2) {
            // Manejar casos null/undefined
            if (!id1 || !id2) return false;
            
            function extraerId(obj) {
                if (typeof obj === 'string') return obj;
                if (typeof obj === 'number') return String(obj);
                
                if (typeof obj === 'object' && obj !== null) {
                    // Intentar diferentes estrategias de extracci√≥n
                    if (obj._id) return String(obj._id);
                    if (obj.$oid) return obj.$oid;
                    
                    // Si toString() devuelve algo √∫til, usarlo
                    const strResult = obj.toString();
                    if (strResult !== '[object Object]') return strResult;
                    
                    // √öLTIMO RECURSO: Parsing manual del JSON
                    try {
                        const jsonStr = JSON.stringify(obj);
                        const match = jsonStr.match(/"\$oid":"([a-f0-9]{24})"/); 
                        if (match) return match[1];
                        
                        // Si no hay $oid, buscar cualquier string de 24 caracteres hex
                        const hexMatch = jsonStr.match(/"([a-f0-9]{24})"/); 
                        if (hexMatch) return hexMatch[1];
                    } catch (e) {
                        console.warn('üö® Error parseando ObjectId:', e);
                    }
                }
                
                return String(obj);
            }
            
            const id1String = extraerId(id1);
            const id2String = extraerId(id2);
            const resultado = id1String === id2String;
            
            // DEBUG: Log de comparaciones para debugging
            if (window.debugComparaciones) {
                console.log(`üîç compararIds: "${id1String}" === "${id2String}" ‚Üí ${resultado}`);
                if (!resultado && (typeof id1 === 'object' || typeof id2 === 'object')) {
                    console.log(`   ‚Ü≥ Objetos originales:`, {id1, id2});
                }
            }
            
            return resultado;
        }
        
        let claseActual = null;
        let estudiantesData = [];
        let equiposData = [];
        let vistaActual = 'estudiantes'; // 'estudiantes' o 'equipos'

        if (!requireAuth() || currentUser.rol !== 'profesor') {
            showAlert('Solo los profesores pueden gestionar clases', 'error');
            window.location.href = '/dashboard.html';
        }

        document.addEventListener('DOMContentLoaded', async () => {
            document.getElementById('navPersonaje').style.display = 'none';
            
            const urlParams = new URLSearchParams(window.location.search);
            const claseId = urlParams.get('id');
            
            if (!claseId) {
                showAlert('ID de clase no especificado', 'error');
                window.location.href = '/dashboard.html';
                return;
            }

            await cargarDatosClase(claseId);
            setupBuscador();
        });

        async function cargarDatosClase(claseId) {
            const cargandoElement = document.getElementById('cargandoClase');
            
            try {
                const response = await fetch(`/api/clases/${claseId}/estudiantes`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('classcraft_token')}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Clase no encontrada o sin permisos');
                }

                const data = await response.json();
                claseActual = data.clase;
                estudiantesData = data.estudiantes;

                document.getElementById('nombreClase').textContent = `üìö ${data.clase.nombre}`;
                document.getElementById('codigoClase').textContent = data.clase.codigo;
                document.getElementById('descripcionClase').textContent = data.clase.descripcion;

                // Cargar equipos ANTES de calcular estad√≠sticas
                await cargarEquiposClase();
                
                const totalEstudiantes = estudiantesData.length;
                // Contar equipos √∫nicos de esta clase espec√≠fica
                const equiposUnicos = equiposData.length;
                const estudiantesActivos = estudiantesData.filter(e => {
                    const ultimaConexion = new Date(e.ultima_conexion);
                    const hoy = new Date();
                    hoy.setHours(0, 0, 0, 0);
                    return ultimaConexion >= hoy;
                }).length;
                const estudiantesConPersonaje = estudiantesData.filter(e => e.personaje !== null);
                const promedioNivel = estudiantesConPersonaje.length > 0 ? 
                    Math.round(estudiantesConPersonaje.reduce((sum, e) => sum + e.nivel, 0) / estudiantesConPersonaje.length) : 0;

                document.getElementById('totalEstudiantes').textContent = totalEstudiantes;
                document.getElementById('totalEquipos').textContent = equiposUnicos;
                document.getElementById('estudiantesActivos').textContent = estudiantesActivos;
                document.getElementById('promedioNivel').textContent = promedioNivel;

                mostrarEstudiantes(estudiantesData);

                cargandoElement.classList.add('hidden');
                document.getElementById('contenidoClase').classList.remove('hidden');

            } catch (error) {
                console.error('Error:', error);
                cargandoElement.innerHTML = `
                    <div style="padding: 15px; background: rgba(254, 215, 215, 0.95); border-radius: 8px; border: 2px solid #fc8181; color: #742a2a;">
                        <h4>‚ùå Error cargando la clase</h4>
                        <p>${error.message}</p>
                        <button class="btn btn-secondary" onclick="window.location.href='/dashboard.html'">
                            Volver al Dashboard
                        </button>
                    </div>
                `;
            }
        }

        async function cargarEquiposClase() {
            try {
                const claseId = claseActual?.id || claseActual?._id;
                
                // üî• USAR ENDPOINT SIMPLE QUE SABEMOS QUE FUNCIONA
                const url = claseId ? `/api/equipos-simple/simple?clase_id=${claseId}` : '/api/equipos-simple/simple';
                
                console.log('üî• USANDO ENDPOINT SIMPLE:', url);
                
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('classcraft_token')}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    equiposData = data.equipos || [];
                    console.log('‚úÖ Equipos SIMPLE cargados:', equiposData.length, equiposData);
                } else {
                    console.log('‚ùå Error respuesta equipos SIMPLE:', response.status);
                    equiposData = [];
                }
            } catch (error) {
                console.error('Error cargando equipos SIMPLE:', error);
                equiposData = [];
            }
        }

        function toggleVistaEquipos() {
            const vistaEquipos = document.getElementById('vistaEquipos');
            const vistaEstudiantes = document.getElementById('vistaEstudiantes');
            const btnToggle = document.getElementById('btnToggleVista');
            
            if (vistaActual === 'estudiantes') {
                vistaActual = 'equipos';
                vistaEquipos.classList.remove('hidden');
                vistaEstudiantes.classList.add('hidden');
                btnToggle.innerHTML = 'üìù Vista Individual';
                mostrarEquipos();
            } else {
                vistaActual = 'estudiantes';
                vistaEquipos.classList.add('hidden');
                vistaEstudiantes.classList.remove('hidden');
                btnToggle.innerHTML = 'üë• Vista por Equipos';
            }
        }

        function mostrarEquipos() {
            const listaEquipos = document.getElementById('listaEquipos');
            
            console.log('üîç DEBUG mostrarEquipos V2');
            console.log('equiposData:', equiposData);
            console.log('estudiantesData:', estudiantesData.map(e => ({
                nombre: e.nombre,
                id: e._id,
                personaje_id: e.personaje?._id || 'NO_PERSONAJE'
            })));
            
            // üî• ACTIVAR DEBUG DE COMPARACIONES PARA FIX QUIR√öRGICO
            window.debugComparaciones = true;
            console.log('üî•üî•üî• INICIANDO FIX QUIR√öRGICO DE OBJECTIDS üî•üî•üî•');
            
            // Mostrar estructura de un equipo de ejemplo
            if (equiposData.length > 0) {
                console.log('üîç Estructura del primer equipo:');
                console.log('- Nombre:', equiposData[0].nombre);
                console.log('- Miembros array:', equiposData[0].miembros);
                console.log('- Tipo de miembros:', equiposData[0].miembros.map(m => typeof m));
                console.log('- Miembros como strings:', equiposData[0].miembros.map(m => {
                    const idString = typeof m === 'object' ? m.toString() : m;
                    console.log(`    Miembro ID convertido: ${idString}`);
                    return idString;
                }));
            }
            
            // NUEVA L√ìGICA: Partir desde los equipos, no desde los estudiantes
            const estudiantesSinEquipo = [];
            const estudiantesConEquipo = new Set(); // Para tracking
            
            let html = '';
            
            // Mostrar equipos existentes
            if (equiposData.length > 0) {
                equiposData.forEach(equipo => {
                    console.log(`üèÜ Procesando equipo: ${equipo.nombre}`);
                    console.log(`   Miembros IDs: ${equipo.miembros}`);
                    
                    // Buscar estudiantes que est√°n en este equipo
                    const miembrosDetalle = [];
                    
                    equipo.miembros.forEach(miembroId => {
                        // üî• FIX QUIR√öRGICO: Forzar conversi√≥n BRUTAL de ObjectIds
                        let miembroIdString;
                        
                        if (typeof miembroId === 'object' && miembroId !== null) {
                            // Si es ObjectId de MongoDB, intentar extraer el string
                            if (miembroId._id) {
                                miembroIdString = miembroId._id.toString();
                            } else if (miembroId.$oid) {
                                miembroIdString = miembroId.$oid;
                            } else if (miembroId.toString && miembroId.toString() !== '[object Object]') {
                                miembroIdString = miembroId.toString();
                            } else {
                                // FALLBACK: Extraer manualmente del ObjectId
                                miembroIdString = JSON.stringify(miembroId).replace(/[{}"]/g, '').split(':')[1] || miembroId;
                            }
                        } else {
                            miembroIdString = String(miembroId);
                        }
                        
                        console.log(`   üîç Procesando miembro:`);
                        console.log(`      Original: ${typeof miembroId} = ${miembroId}`);
                        console.log(`      Convertido: ${miembroIdString}`);
                        console.log(`      Es ObjectId?: ${miembroId.constructor?.name}`);
                        console.log(`      JSON: ${JSON.stringify(miembroId)}`);
                        
                        // DEBUG: Mostrar todos los IDs disponibles para comparar
                        console.log('   üîç IDs disponibles en estudiantesData:');
                        estudiantesData.forEach(e => {
                            console.log(`      - ${e.nombre}: usuario_id=${e._id}, personaje_id=${e.personaje?._id || 'NO_PERSONAJE'}`);
                        });
                        
                        // Buscar por personaje_id PRIMERO (m√°s probable), luego por usuario_id
                        const estudiante = estudiantesData.find(e => 
                            (e.personaje && compararIds(e.personaje._id, miembroId)) || // Por personaje_id PRIMERO
                            compararIds(e._id, miembroId) // Por usuario_id despu√©s
                        );
                        
                        // DEBUG ADICIONAL: Verificar por qu√© no encuentra
                        if (!estudiante) {
                            console.log(`   ‚ùå MIEMBRO NO ENCONTRADO - Verificaci√≥n detallada:`);
                            console.log(`      Miembro ID buscado: ${miembroIdString}`);
                            
                            // Probar cada estudiante individualmente
                            estudiantesData.forEach(e => {
                                const usuarioMatch = compararIds(e._id, miembroId);
                                const personajeMatch = e.personaje && compararIds(e.personaje._id, miembroId);
                                console.log(`      ${e.nombre}: usuario_id=${e._id} (match: ${usuarioMatch}), personaje_id=${e.personaje?._id || 'NO_PERSONAJE'} (match: ${personajeMatch})`);
                            });
                        }
                        
                        if (estudiante) {
                            miembrosDetalle.push(estudiante);
                            estudiantesConEquipo.add(estudiante._id);
                            console.log(`   ‚úÖ Miembro encontrado: ${estudiante.nombre}`);
                        } else {
                            console.log(`   ‚ùå Miembro no encontrado para ID: ${miembroIdString}`);
                            console.log(`   ‚ùå No coincide con ning√∫n usuario_id ni personaje_id`);
                        }
                    });
                    
                    const promedioNivel = miembrosDetalle.length > 0 ? 
                        Math.round(miembrosDetalle.reduce((sum, m) => sum + m.nivel, 0) / miembrosDetalle.length) : 0;
                    
                    html += `
                        <div class="equipo-seccion" style="background: #e6fffa; padding: 20px; border-radius: 12px; margin: 20px 0; border-left: 4px solid #38b2ac; border: 2px solid #CD853F; box-shadow: 0 6px 16px rgba(139, 69, 19, 0.25); transition: all 0.3s ease;">
                            <div class="equipo-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 1px solid rgba(205, 133, 63, 0.3); padding-bottom: 10px;">
                                <div>
                                    <h4 style="color: #2F1B14; margin: 0; text-shadow: 1px 1px 2px rgba(139, 69, 19, 0.2);">‚öîÔ∏è ${equipo.nombre}</h4>
                                    <p style="margin: 5px 0; color: #8B4513;">üë• ${miembrosDetalle.length}/4 miembros | üèÜ ${equipo.puntos} puntos | üìä Nivel promedio: ${promedioNivel}</p>
                                </div>
                                <div>
                                    <button class="btn btn-warning btn-sm" onclick="gestionarPuntosEquipo('${equipo._id}', '${equipo.nombre}')"><span style="filter: drop-shadow(1px 1px 2px rgba(139, 69, 19, 0.3));">üí∞ Puntos</span></button>
                                </div>
                            </div>
                            
                            <div class="miembros-equipo" style="display: grid; gap: 10px;">
                                ${miembrosDetalle.map(miembro => {
                                    const p = miembro.personaje;
                                    const ultimaConexion = new Date(miembro.ultima_conexion);
                                    const esActivo = (new Date() - ultimaConexion) < 24 * 60 * 60 * 1000;
                                    
                                    return `
                                        <div class="miembro-equipo" style="background: white; padding: 15px; border-radius: 8px; display: grid; grid-template-columns: 1fr 1fr 150px; gap: 15px; align-items: center; border: 1px solid rgba(205, 133, 63, 0.2); box-shadow: 0 3px 8px rgba(139, 69, 19, 0.15); transition: all 0.2s ease;">
                                            <div>
                                                <h5 style="color: #2F1B14; margin-bottom: 5px; text-shadow: 0.5px 0.5px 1px rgba(139, 69, 19, 0.1);">
                                                    ${miembro.nombre}
                                                    ${esActivo ? '<span style="color: #48bb78;">üü¢</span>' : '<span style="color: #a0aec0;">‚ö´</span>'}
                                                </h5>
                                                <p style="margin: 2px 0; font-size: 0.9em; color: #8B4513;">${p.clase || 'N/A'} ${p.raza || ''}</p>
                                            </div>
                                            
                                            <div style="font-size: 0.85em;">
                                                <div>Nivel: ${miembro.nivel} | XP: ${miembro.experiencia}</div>
                                                <div>‚ù§Ô∏è ${p.salud?.actual || 0}/${p.salud?.maxima || 0} | ‚ö° ${p.energia?.actual || 0}/${p.energia?.maxima || 0}</div>
                                            </div>
                                            
                                            <div>
                                                <button class="btn btn-primary btn-sm" onclick="mostrarModalAcciones('${miembro._id}', '${miembro.nombre}')">
                                                    ‚ö° Acciones
                                                </button>
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    `;
                });
            }
            
            // Identificar estudiantes sin equipo
            estudiantesData.forEach(estudiante => {
                if (!estudiantesConEquipo.has(estudiante._id)) {
                    estudiantesSinEquipo.push(estudiante);
                }
            });
            
            // Mostrar estudiantes sin equipo
            if (estudiantesSinEquipo.length > 0) {
                html += `
                    <div class="sin-equipo-seccion" style="background: #fef5e7; padding: 20px; border-radius: 12px; margin: 20px 0; border-left: 4px solid #f6ad55; border: 2px solid #CD853F; box-shadow: 0 6px 16px rgba(139, 69, 19, 0.25);">
                        <div class="sin-equipo-header" style="margin-bottom: 15px; border-bottom: 1px solid rgba(205, 133, 63, 0.3); padding-bottom: 10px;">
                            <h4 style="color: #2F1B14; margin: 0; text-shadow: 1px 1px 2px rgba(139, 69, 19, 0.2);">üö´ Sin Equipo (${estudiantesSinEquipo.length} estudiantes)</h4>
                            <p style="margin: 5px 0; color: #8B4513;">Estos estudiantes pueden unirse a equipos existentes o formar nuevos equipos</p>
                        </div>
                        
                        <div class="estudiantes-sin-equipo" style="display: grid; gap: 10px;">
                            ${estudiantesSinEquipo.map(estudiante => {
                                const p = estudiante.personaje;
                                const ultimaConexion = new Date(estudiante.ultima_conexion);
                                const esActivo = (new Date() - ultimaConexion) < 24 * 60 * 60 * 1000;
                                
                                if (!p) {
                                    return `
                                        <div class="estudiante-sin-equipo" style="background: #fed7d7; padding: 15px; border-radius: 8px; display: grid; grid-template-columns: 1fr 1fr 150px; gap: 15px; align-items: center; border: 1px solid rgba(205, 133, 63, 0.3); box-shadow: 0 3px 8px rgba(139, 69, 19, 0.15);">
                                            <div>
                                                <h5 style="color: #2F1B14; margin-bottom: 5px; text-shadow: 0.5px 0.5px 1px rgba(139, 69, 19, 0.1);">
                                                    ${estudiante.nombre}
                                                    ${esActivo ? '<span style="color: #48bb78;">üü¢</span>' : '<span style="color: #a0aec0;">‚ö´</span>'}
                                                    <span style="color: #e53e3e; margin-left: 8px;">‚ö†Ô∏è Sin Personaje</span>
                                                </h5>
                                                <p style="margin: 2px 0; font-size: 0.9em; color: #e53e3e;">Debe crear personaje</p>
                                            </div>
                                            
                                            <div style="font-size: 0.85em;">
                                                <div>Nivel: ${estudiante.nivel} | XP: ${estudiante.experiencia}</div>
                                                <div style="color: #e53e3e;">No puede unirse a equipos</div>
                                            </div>
                                            
                                            <div>
                                                <button class="btn btn-primary btn-sm" onclick="mostrarModalAcciones('${estudiante._id}', '${estudiante.nombre}')">
                                                    ‚ö° Dar XP
                                                </button>
                                            </div>
                                        </div>
                                    `;
                                } else {
                                    return `
                                        <div class="estudiante-sin-equipo" style="background: white; padding: 15px; border-radius: 8px; display: grid; grid-template-columns: 1fr 1fr 150px; gap: 15px; align-items: center; border: 1px solid rgba(205, 133, 63, 0.2); box-shadow: 0 3px 8px rgba(139, 69, 19, 0.15);">
                                            <div>
                                                <h5 style="color: #2F1B14; margin-bottom: 5px; text-shadow: 0.5px 0.5px 1px rgba(139, 69, 19, 0.1);">
                                                    ${estudiante.nombre}
                                                    ${esActivo ? '<span style="color: #48bb78;">üü¢</span>' : '<span style="color: #a0aec0;">‚ö´</span>'}
                                                </h5>
                                                <p style="margin: 2px 0; font-size: 0.9em; color: #8B4513;">${p.clase || 'N/A'} ${p.raza || ''}</p>
                                            </div>
                                            
                                            <div style="font-size: 0.85em;">
                                                <div>Nivel: ${estudiante.nivel} | XP: ${estudiante.experiencia}</div>
                                                <div>‚ù§Ô∏è ${p.salud?.actual || 0}/${p.salud?.maxima || 0} | ‚ö° ${p.energia?.actual || 0}/${p.energia?.maxima || 0}</div>
                                            </div>
                                            
                                            <div>
                                                <button class="btn btn-primary btn-sm" onclick="mostrarModalAcciones('${estudiante._id}', '${estudiante.nombre}')">
                                                    ‚ö° Acciones
                                                </button>
                                            </div>
                                        </div>
                                    `;
                                }
                            }).join('')}
                        </div>
                    </div>
                `;
            }
            
            if (html === '') {
                html = `
                    <div class="alert alert-info">
                        <p>üè´ No hay equipos formados a√∫n en esta clase.</p>
                        <p>Los estudiantes pueden formar equipos desde la p√°gina de Equipos.</p>
                    </div>
                `;
            }
            
            listaEquipos.innerHTML = html;
        }

        function gestionarPuntosEquipo(equipoId, equipoNombre) {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content">
                    <h3>üí∞ Gestionar Puntos - ${equipoNombre}</h3>
                    
                    <div class="form-group">
                        <label for="operacionPuntosEquipo">Operaci√≥n:</label>
                        <select id="operacionPuntosEquipo">
                            <option value="agregar">‚ûï Agregar puntos</option>
                            <option value="quitar">‚ûñ Quitar puntos</option>
                            <option value="establecer">üéØ Establecer puntos</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="cantidadPuntosEquipo">Cantidad:</label>
                        <input type="number" id="cantidadPuntosEquipo" min="0" placeholder="Ej: 10, 50">
                    </div>

                    <div class="form-group">
                        <label for="razonPuntosEquipo">Raz√≥n:</label>
                        <input type="text" id="razonPuntosEquipo" placeholder="Ej: Trabajo en equipo excelente">
                    </div>

                    <div class="form-actions">
                        <button class="btn btn-secondary" onclick="cerrarModal(this)">Cancelar</button>
                        <button class="btn btn-primary" onclick="ejecutarAccionEquipo('${equipoId}', this)">Aplicar</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            modal.style.display = 'flex';
        }

        async function ejecutarAccionEquipo(equipoId, modalElement) {
            const operacion = document.getElementById('operacionPuntosEquipo').value;
            const cantidad = parseInt(document.getElementById('cantidadPuntosEquipo').value);
            const razon = document.getElementById('razonPuntosEquipo').value.trim();

            if (isNaN(cantidad) || cantidad < 0) {
                showAlert('Por favor ingresa una cantidad v√°lida', 'error');
                return;
            }

            if (!razon) {
                showAlert('Por favor proporciona una raz√≥n', 'error');
                return;
            }

            try {
                const response = await fetch(`/api/equipos/${equipoId}/puntos`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('classcraft_token')}`
                    },
                    body: JSON.stringify({
                        operacion,
                        cantidad,
                        razon
                    })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Error gestionando puntos');
                }

                showAlert(`‚úÖ Puntos del equipo actualizados: ${data.puntos_anteriores} ‚Üí ${data.puntos_actuales}`, 'success');
                cerrarModal(modalElement);
                
                const claseId = claseActual.id || claseActual._id;
                await cargarDatosClase(claseId);

            } catch (error) {
                console.error('Error:', error);
                showAlert('Error: ' + error.message, 'error');
            }
        }

        function mostrarEstudiantes(estudiantes) {
            const listaElement = document.getElementById('listaEstudiantes');
            
            if (estudiantes.length === 0) {
                listaElement.innerHTML = `
                    <div style="padding: 15px; background: rgba(245, 235, 215, 0.95); border-radius: 8px; border: 2px solid #CD853F; color: #2F1B14; border-left: 4px solid #DAA520;">
                        <p>No hay estudiantes registrados en esta clase a√∫n.</p>
                        <p>Comparte el c√≥digo <strong>${claseActual.codigo}</strong> con tus estudiantes para que se unan.</p>
                    </div>
                `;
                return;
            }

            listaElement.innerHTML = estudiantes.map(estudiante => {
                const p = estudiante.personaje;
                const ultimaConexion = new Date(estudiante.ultima_conexion);
                const esActivo = (new Date() - ultimaConexion) < 24 * 60 * 60 * 1000;
                
                // Manejar estudiantes sin personaje
                if (!p) {
                    return `
                        <div class="estudiante-card" style="background: #fef5e7; padding: 20px; border-radius: 8px; margin: 15px 0; border: 2px solid #f6ad55;">
                            <div style="display: grid; grid-template-columns: 1fr 200px; gap: 20px; align-items: center;">
                                <div>
                                    <h4 style="color: #4a5568; margin-bottom: 8px;">
                                        ${estudiante.nombre}
                                        ${esActivo ? '<span style="color: #48bb78;">üü¢</span>' : '<span style="color: #a0aec0;">‚ö´</span>'}
                                        <span style="color: #f6ad55; margin-left: 8px;">‚ö†Ô∏è Sin Personaje</span>
                                    </h4>
                                    <p style="margin: 3px 0;"><strong>Email:</strong> ${estudiante.email}</p>
                                    <p style="margin: 3px 0; color: #d69e2e;"><strong>Estado:</strong> Necesita crear personaje</p>
                                    <p style="margin: 3px 0;"><strong>Nivel:</strong> ${estudiante.nivel} | <strong>XP:</strong> ${estudiante.experiencia}</p>
                                    <p style="margin-top: 8px; color: #718096; font-size: 0.85em;">
                                        √öltima conexi√≥n: ${ultimaConexion.toLocaleDateString()}
                                    </p>
                                </div>
                                
                                <div style="display: flex; flex-direction: column; gap: 8px;">
                                    <button class="btn btn-primary btn-sm" onclick="mostrarModalAcciones('${estudiante._id}', '${estudiante.nombre}')">
                                        ‚ö° Dar XP
                                    </button>
                                    <p style="font-size: 0.8em; color: #718096; text-align: center;">El estudiante debe crear su personaje</p>
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                return `
                    <div class="estudiante-card" style="background: #f7fafc; padding: 20px; border-radius: 8px; margin: 15px 0; border: 1px solid #e2e8f0;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr 200px; gap: 20px; align-items: center;">
                            <div>
                                <h4 style="color: #4a5568; margin-bottom: 8px;">
                                    ${estudiante.nombre}
                                    ${esActivo ? '<span style="color: #48bb78;">üü¢</span>' : '<span style="color: #a0aec0;">‚ö´</span>'}
                                </h4>
                                <p style="margin: 3px 0;"><strong>Email:</strong> ${estudiante.email}</p>
                                <p style="margin: 3px 0;"><strong>Personaje:</strong> ${p.clase || 'N/A'} ${p.raza || ''}</p>
                                <p style="margin: 3px 0;"><strong>Equipo:</strong> ${p.equipo || 'Sin equipo'}</p>
                            </div>
                            
                            <div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 0.9em;">
                                    <div><strong>Nivel:</strong> ${estudiante.nivel || 1}</div>
                                    <div><strong>XP:</strong> ${estudiante.experiencia || 0}</div>
                                    <div><strong>Salud:</strong> ${p.salud?.actual || 0}/${p.salud?.maxima || 0}</div>
                                    <div><strong>Energ√≠a:</strong> ${p.energia?.actual || 0}/${p.energia?.maxima || 0}</div>
                                </div>
                                <p style="margin-top: 8px; color: #718096; font-size: 0.85em;">
                                    √öltima conexi√≥n: ${ultimaConexion.toLocaleDateString()}
                                </p>
                            </div>
                            
                            <div style="display: flex; flex-direction: column; gap: 8px;">
                                <button class="btn btn-primary btn-sm" onclick="mostrarModalAcciones('${estudiante._id}', '${estudiante.nombre}')">
                                    ‚ö° Acciones
                                </button>
                                <button class="btn btn-secondary btn-sm" onclick="verDetallesEstudiante('${estudiante._id}')">
                                    üëÅÔ∏è Detalles
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function setupBuscador() {
            const buscador = document.getElementById('buscarEstudiante');
            buscador.addEventListener('input', (e) => {
                const termino = e.target.value.toLowerCase();
                const estudiantesFiltrados = estudiantesData.filter(estudiante => 
                    estudiante.nombre.toLowerCase().includes(termino) ||
                    estudiante.email.toLowerCase().includes(termino) ||
                    (estudiante.personaje && (
                        (estudiante.personaje.clase && estudiante.personaje.clase.toLowerCase().includes(termino)) ||
                        (estudiante.personaje.raza && estudiante.personaje.raza.toLowerCase().includes(termino))
                    ))
                );
                mostrarEstudiantes(estudiantesFiltrados);
            });
        }

        function mostrarModalAcciones(estudianteId, nombreEstudiante) {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content">
                    <h3>‚ö° Acciones para ${nombreEstudiante}</h3>
                    
                    <div class="form-group">
                        <label for="tipoAccion">Tipo de acci√≥n:</label>
                        <select id="tipoAccion">
                            <option value="xp">Dar/Quitar XP</option>
                            <option value="salud">Modificar Salud</option>
                            <option value="energia">Modificar Energ√≠a</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="valorAccion">Valor:</label>
                        <input type="number" id="valorAccion" placeholder="Ej: 10, -5">
                        <small>N√∫meros positivos aumentan, negativos disminuyen</small>
                    </div>

                    <div class="form-group">
                        <label for="razonAccion">Raz√≥n:</label>
                        <input type="text" id="razonAccion" placeholder="Ej: Participaci√≥n activa, comportamiento inadecuado">
                    </div>

                    <div class="form-actions">
                        <button class="btn btn-secondary" onclick="cerrarModal(this)">Cancelar</button>
                        <button class="btn btn-primary" onclick="ejecutarAccion('${estudianteId}', this)">Aplicar</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            modal.style.display = 'flex';
        }

        async function ejecutarAccion(estudianteId, modalElement) {
            const tipo = document.getElementById('tipoAccion').value;
            const valor = parseInt(document.getElementById('valorAccion').value);
            const razon = document.getElementById('razonAccion').value.trim();

            if (isNaN(valor) || valor === 0) {
                showAlert('Por favor ingresa un valor v√°lido', 'error');
                return;
            }

            if (!razon) {
                showAlert('Por favor proporciona una raz√≥n', 'error');
                return;
            }

            try {
                let endpoint, payload;
                
                const claseId = claseActual.id || claseActual._id;
                
                if (tipo === 'xp') {
                    endpoint = `/api/clases/${claseId}/estudiante/${estudianteId}/xp`;
                    payload = { cantidad: valor, razon };
                } else {
                    endpoint = `/api/clases/${claseId}/estudiante/${estudianteId}/stats`;
                    // Construir payload seg√∫n el tipo seleccionado
                    payload = { razon };
                    if (tipo === 'salud') {
                        payload.salud = valor;
                    } else if (tipo === 'energia') {
                        payload.energia = valor;
                    }
                }



                const response = await fetch(endpoint, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('classcraft_token')}`
                    },
                    body: JSON.stringify(payload)
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Error ejecutando acci√≥n');
                }

                showAlert(`‚úÖ Acci√≥n ejecutada exitosamente`, 'success');
                cerrarModal(modalElement);
                
                await cargarDatosClase(claseId);

            } catch (error) {
                console.error('Error:', error);
                showAlert('Error: ' + error.message, 'error');
            }
        }

        function mostrarAccionesMasivas() {
            document.getElementById('modalAccionesMasivas').classList.remove('hidden');
            document.getElementById('modalAccionesMasivas').style.display = 'flex';
        }

        function cerrarModalAccionesMasivas() {
            document.getElementById('modalAccionesMasivas').style.display = 'none';
        }

        async function ejecutarAccionMasiva() {
            const tipo = document.getElementById('tipoAccionMasiva').value;
            const valor = parseInt(document.getElementById('valorAccionMasiva').value);
            const razon = document.getElementById('razonAccionMasiva').value.trim();

            if (isNaN(valor) || valor === 0) {
                showAlert('Por favor ingresa un valor v√°lido', 'error');
                return;
            }

            if (!razon) {
                showAlert('Por favor proporciona una raz√≥n', 'error');
                return;
            }

            if (!confirm(`¬øEst√°s seguro de aplicar esta acci√≥n a TODOS los estudiantes (${estudiantesData.length})?`)) {
                return;
            }

            try {
                // ‚úÖ FIX: Usar claseActual.id en lugar de claseActual._id
                const claseId = claseActual.id || claseActual._id;
                
                const promises = estudiantesData.map(async (estudiante) => {
                    let endpoint, payload;
                    
                    if (tipo === 'xp') {
                        endpoint = `/api/clases/${claseId}/estudiante/${estudiante._id}/xp`;
                        payload = { cantidad: valor, razon };
                    } else {
                        endpoint = `/api/clases/${claseId}/estudiante/${estudiante._id}/stats`;
                        // Construir payload seg√∫n el tipo seleccionado
                        payload = { razon };
                        if (tipo === 'salud') {
                            payload.salud = valor;
                        } else if (tipo === 'energia') {
                            payload.energia = valor;
                        }
                    }

                    return fetch(endpoint, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${localStorage.getItem('classcraft_token')}`
                        },
                        body: JSON.stringify(payload)
                    });
                });

                await Promise.all(promises);
                
                showAlert(`‚úÖ Acci√≥n aplicada a ${estudiantesData.length} estudiantes`, 'success');
                cerrarModalAccionesMasivas();
                
                document.getElementById('valorAccionMasiva').value = '';
                document.getElementById('razonAccionMasiva').value = '';
                
                await cargarDatosClase(claseId);

            } catch (error) {
                console.error('Error:', error);
                showAlert('Error ejecutando acciones masivas: ' + error.message, 'error');
            }
        }

        function verDetallesEstudiante(estudianteId) {
            const estudiante = estudiantesData.find(e => e._id === estudianteId);
            if (estudiante) {
                const p = estudiante.personaje;
                
                if (!p) {
                    alert(`Detalles de ${estudiante.nombre}:\\n\\n` +
                        `Email: ${estudiante.email}\\n` +
                        `Estado: Sin personaje creado\\n` +
                        `Nivel: ${estudiante.nivel} | XP: ${estudiante.experiencia}\\n` +
                        `√öltima conexi√≥n: ${new Date(estudiante.ultima_conexion).toLocaleString()}\\n\\n` +
                        `El estudiante debe crear su personaje para participar completamente.`);
                } else {
                    alert(`Detalles de ${estudiante.nombre}:\\n\\n` +
                        `Email: ${estudiante.email}\\n` +
                        `Personaje: ${p.clase || 'N/A'} ${p.raza || ''}\\n` +
                        `Nivel: ${estudiante.nivel} | XP: ${estudiante.experiencia}\\n` +
                        `Salud: ${p.salud?.actual || 0}/${p.salud?.maxima || 0}\\n` +
                        `Energ√≠a: ${p.energia?.actual || 0}/${p.energia?.maxima || 0}\\n` +
                        `Equipo: ${p.equipo || 'Sin equipo'}\\n` +
                        `√öltima conexi√≥n: ${new Date(estudiante.ultima_conexion).toLocaleString()}`);
                }
            }
        }

        function verEquiposDeClase() {
            // Redirigir a la p√°gina de equipos con el filtro de la clase actual
            const claseId = claseActual.id || claseActual._id;
            window.location.href = `/equipos.html?clase_id=${claseId}`;
        }

        function cerrarModal(element) {
            const modal = element.closest('.modal');
            if (modal) {
                document.body.removeChild(modal);
            }
        }
    </script>

    <style>
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 8px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .btn-sm {
            padding: 6px 12px;
            font-size: 0.85em;
        }
        
        .estudiante-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transition: all 0.2s ease;
        }
        
        /* Efectos hover para vista de equipos - ClassCraft theme */
        .equipo-seccion:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(139, 69, 19, 0.35);
            border-color: #DAA520;
        }
        
        .sin-equipo-seccion:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(139, 69, 19, 0.35);
            border-color: #DAA520;
        }
        
        .miembro-equipo:hover,
        .estudiante-sin-equipo:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 12px rgba(139, 69, 19, 0.25);
            border-color: #CD853F;
        }
    </style>
</body>
</html>