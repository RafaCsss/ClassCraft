<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Equipos - ClassCraft</title>
    <link href="css/style.css" rel="stylesheet">
</head>
<body>
    <div class="header">
        <div class="header-content container">
            <div class="logo-section">
                <img src="/images/LOGO.png" alt="ClassCraft" class="main-logo" style="max-width: 250px;">
            </div>
            <div class="auth-buttons">
                <a href="/dashboard.html" class="btn btn-secondary">Dashboard</a>
                <button onclick="logout()" class="btn btn-secondary">Cerrar Sesi√≥n</button>
            </div>
        </div>
    </div>

    <!-- Secci√≥n de Tips -->
    <div class="container">
        <div class="card tips-section">
            <h3>‚öîÔ∏è Estrategias de Equipos</h3>
            <div class="tips-grid">
                <div class="tip-card">
                    <span class="tip-icon">üõ°Ô∏è</span>
                    <h4>Balance de Clases</h4>
                    <p>Un equipo balanceado con diferentes clases (Mago, Guerrero, Curandero) tiene mejores posibilidades de √©xito en misiones complejas.</p>
                </div>
                <div class="tip-card">
                    <span class="tip-icon">üéØ</span>
                    <h4>Cooperaci√≥n</h4>
                    <p>Los equipos que trabajan juntos y se apoyan mutuamente obtienen bonificaciones especiales en XP y recursos.</p>
                </div>
                <div class="tip-card">
                    <span class="tip-icon">üìà</span>
                    <h4>Progreso Constante</h4>
                    <p>La participaci√≥n regular de todos los miembros es clave para mantener al equipo en los primeros lugares del ranking.</p>
                </div>
            </div>
        </div>
    </div>

    <div class="container">

        <!-- Selector de Clase -->
        <div class="clase-selector-container card" id="claseSelectorContainer" style="display: none;">
            <h3>üè∑Ô∏è Seleccionar Clase</h3>
            <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
                <select id="selectorClase" class="form-select" style="min-width: 200px;">
                    <option value="">Todos los equipos</option>
                </select>
                <span id="claseActualInfo" class="badge badge-info"></span>
            </div>
        </div>

        <div class="equipos-container">
            <!-- Panel para profesores -->
            <div id="panel-profesor" class="profesor-panel card" style="display: none;">
                <h3>üë®‚Äçüè´ Panel del Profesor</h3>
                <div class="acciones-profesor">
                    <button onclick="mostrarCrearEquipo()" class="btn btn-success">+ Crear Equipo</button>
                    <button onclick="verRanking()" class="btn btn-info">üèÜ Ver Ranking</button>
                </div>
            </div>

            <!-- Panel para estudiantes -->
            <div id="panel-estudiante" class="estudiante-panel card" style="display: none;">
                <h3>üéì Panel del Estudiante</h3>
                <div id="mi-equipo-info"></div>
                <div class="acciones-estudiante">
                    <button onclick="salirDeEquipo()" class="btn btn-danger" id="btn-salir-equipo" style="display: none;">üö™ Salir del Equipo</button>
                </div>
            </div>

            <!-- Lista de equipos -->
            <div class="equipos-lista">
                <div class="equipos-header">
                    <h3>üèõÔ∏è Equipos Disponibles</h3>
                </div>
                <div id="equipos-grid" class="equipos-grid">
                    <!-- Equipos se cargan aqu√≠ -->
                </div>
            </div>
        </div>

        <!-- Modal crear equipo -->
        <div id="modal-crear-equipo" class="modal" style="display: none;">
            <div class="modal-content">
                <h3>‚öîÔ∏è Crear Nuevo Equipo</h3>
                <form id="form-crear-equipo">
                    <div class="form-group">
                        <label for="clase-equipo">Clase:</label>
                        <select id="clase-equipo" class="form-select">
                            <option value="">Equipo Global (sin clase espec√≠fica)</option>
                        </select>
                        <small id="form-help-text" class="form-help">Los equipos globales pueden incluir estudiantes de cualquier clase</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="nombre-equipo">Nombre del Equipo:</label>
                        <input type="text" id="nombre-equipo" required maxlength="50">
                    </div>
                    
                    <div class="form-group">
                        <label for="color-equipo">Color del Equipo:</label>
                        <input type="color" id="color-equipo" value="#007bff">
                    </div>
                    
                    <div class="modal-actions">
                        <button type="submit" class="btn btn-success">Crear Equipo</button>
                        <button type="button" onclick="cerrarModal('modal-crear-equipo')" class="btn btn-secondary">Cancelar</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Modal gestionar puntos -->
        <div id="modal-puntos" class="modal" style="display: none;">
            <div class="modal-content">
                <h3>üí∞ Gestionar Puntos</h3>
                <div id="equipo-puntos-info"></div>
                <form id="form-puntos">
                    <div class="form-group">
                        <label for="operacion-puntos">Operaci√≥n:</label>
                        <select id="operacion-puntos" required>
                            <option value="agregar">‚ûï Agregar</option>
                            <option value="quitar">‚ûñ Quitar</option>
                            <option value="establecer">üéØ Establecer</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="cantidad-puntos">Cantidad:</label>
                        <input type="number" id="cantidad-puntos" min="0" required>
                    </div>
                    <div class="form-group">
                        <label for="razon-puntos">Raz√≥n:</label>
                        <input type="text" id="razon-puntos" placeholder="Motivo del cambio...">
                    </div>
                    <div class="modal-actions">
                        <button type="submit" class="btn btn-success">Aplicar</button>
                        <button type="button" onclick="cerrarModal('modal-puntos')" class="btn btn-secondary">Cancelar</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Modal ranking -->
        <div id="modal-ranking" class="modal" style="display: none;">
            <div class="modal-content modal-large">
                <h3>üèÜ Ranking de Equipos</h3>
                <div id="ranking-container"></div>
                <div class="modal-actions">
                    <button onclick="cerrarModal('modal-ranking')" class="btn btn-secondary">Cerrar</button>
                </div>
            </div>
        </div>
    </div>

    <footer class="epic-footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <h3>ClassCraft</h3>
                    <p>Transformando la educaci√≥n a trav√©s de la gamificaci√≥n y aventuras √©picas en el aula.</p>
                </div>
                <div class="footer-section">
                    <h3>Recursos</h3>
                    <ul class="footer-links">
                        <li><a href="#">Gu√≠a del Profesor</a></li>
                        <li><a href="#">Manual del Estudiante</a></li>
                        <li><a href="#">Habilidades & Clases</a></li>
                        <li><a href="#">Sistema de Puntos</a></li>
                    </ul>
                </div>
                <div class="footer-section">
                    <h3>Soporte</h3>
                    <ul class="footer-links">
                        <li><a href="#">Centro de Ayuda</a></li>
                        <li><a href="#">Reportar Bug</a></li>
                        <li><a href="#">Sugerir Mejora</a></li>
                        <li><a href="#">Contacto</a></li>
                    </ul>
                </div>
                <div class="footer-section">
                    <h3>Comunidad</h3>
                    <div class="social-links">
                        <a href="#" class="social-link">
                            <span class="social-icon">üìò</span> Facebook
                        </a>
                        <a href="#" class="social-link">
                            <span class="social-icon">üê¶</span> Twitter
                        </a>
                        <a href="#" class="social-link">
                            <span class="social-icon">üì∑</span> Instagram
                        </a>
                    </div>
                </div>
            </div>
            <div class="footer-bottom">
                <div class="credits">
                    <p>Desarrollado con ‚ù§Ô∏è por <strong>Rafael Inga Tello</strong></p>
                    <p class="tech-stack">Node.js ‚Ä¢ MongoDB ‚Ä¢ Express ‚Ä¢ Vanilla JS</p>
                </div>
                <div class="footer-logo">
                    <div class="mini-logo">Class<span>Craft</span></div>
                </div>
            </div>
        </div>
    </footer>

    <script>
        let userRole = null;
        let equipoActual = null;
        let equipos = [];
        let clasesDisponibles = [];
        let claseSeleccionada = null; // null = todos los equipos, ID = clase espec√≠fica

        document.addEventListener('DOMContentLoaded', function() {
            verificarAuth();
            
            // Detectar si viene de gestionar-clase con clase_id
            const urlParams = new URLSearchParams(window.location.search);
            const claseIdFromUrl = urlParams.get('clase_id');
            
            if (claseIdFromUrl) {
                // Pre-seleccionar la clase en el selector
                preseleccionarClase(claseIdFromUrl);
            }
            
            inicializarPagina();
        });

        function preseleccionarClase(claseId) {
            // Guardar la clase pre-seleccionada para cuando se carguen las opciones
            claseSeleccionada = claseId;
            console.log('üéØ Pre-seleccionando clase:', claseId);
        }

        function verificarAuth() {
            const token = localStorage.getItem('classcraft_token');
            const user = JSON.parse(localStorage.getItem('classcraft_user') || '{}');
            
            if (!token) {
                location.href = 'login.html';
                return;
            }
            
            userRole = user.rol;
        }

        async function inicializarPagina() {
            if (userRole === 'profesor') {
                document.getElementById('panel-profesor').style.display = 'block';
                document.getElementById('claseSelectorContainer').style.display = 'block';
                await cargarClasesProfesor();
            } else {
                document.getElementById('panel-estudiante').style.display = 'block';
                await verificarEquipoEstudiante();
                await cargarClasesEstudiante();
                
                // Mostrar selector solo si tiene m√∫ltiples clases
                if (clasesDisponibles.length > 1) {
                    document.getElementById('claseSelectorContainer').style.display = 'block';
                }
            }

            await cargarEquipos();
            configurarEventos();
            actualizarInfoClaseActual();
        }

        async function cargarClasesProfesor() {
            try {
                const token = localStorage.getItem('classcraft_token');
                const response = await fetch('/api/clases/mis-clases', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Error al cargar clases');
                }

                const data = await response.json();
                
                console.log('üîç DEBUG - verificarEquipoEstudiante response:', data);
                clasesDisponibles = data.clases;
                
                // Llenar selectores
                llenarSelectoresClases();
                
            } catch (error) {
                console.error('Error:', error);
                alert('Error al cargar clases: ' + error.message);
            }
        }

        async function cargarClasesEstudiante() {
            try {
                const token = localStorage.getItem('classcraft_token');
                const response = await fetch('/api/clases/mis-clases', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Error al cargar clases');
                }

                const data = await response.json();
                clasesDisponibles = data.clases;
                
                // Solo llenar selector principal para estudiantes
                const selectorClase = document.getElementById('selectorClase');
                selectorClase.innerHTML = '<option value="">Todos los equipos disponibles</option>';
                
                clasesDisponibles.forEach(clase => {
                    const option = document.createElement('option');
                    option.value = clase.id;
                    option.textContent = `${clase.nombre} (${clase.codigo})`;
                    selectorClase.appendChild(option);
                });
                
                // Si hay una clase pre-seleccionada, establecerla
                if (claseSeleccionada) {
                    console.log('üéØ Aplicando selecci√≥n autom√°tica de clase para estudiante:', claseSeleccionada);
                    selectorClase.value = claseSeleccionada;
                    actualizarInfoClaseActual();
                }
                
            } catch (error) {
                console.error('Error:', error);
            }
        }

        function llenarSelectoresClases() {
            console.log('üîç DEBUG llenarSelectoresClases - clasesDisponibles:', clasesDisponibles);
            
            // Selector principal
            const selectorClase = document.getElementById('selectorClase');
            selectorClase.innerHTML = '<option value="">Todos mis equipos</option>';
            
            // Selector del modal crear equipo
            const claseEquipo = document.getElementById('clase-equipo');
            const helpText = document.getElementById('form-help-text');
            
            // NUEVA L√ìGICA: Si hay una clase pre-seleccionada (viene de gestionar-clase),
            // no mostrar opci√≥n global
            const vieneDeGestionarClase = claseSeleccionada !== null;
            
            if (vieneDeGestionarClase) {
                // Solo mostrar las clases disponibles, sin opci√≥n global
                claseEquipo.innerHTML = '';
                helpText.textContent = 'Selecciona la clase para crear el equipo';
            } else {
                // Comportamiento normal: incluir opci√≥n global
                claseEquipo.innerHTML = '<option value="">Equipo Global (sin clase espec√≠fica)</option>';
                helpText.textContent = 'Los equipos globales pueden incluir estudiantes de cualquier clase';
            }
            
            clasesDisponibles.forEach(clase => {
                console.log('üîç Agregando clase al selector:', { id: clase.id, nombre: clase.nombre, codigo: clase.codigo });
                
                // Selector principal
                const option1 = document.createElement('option');
                option1.value = clase.id;
                option1.textContent = `${clase.nombre} (${clase.codigo})`;
                selectorClase.appendChild(option1);
                
                // Selector modal
                const option2 = document.createElement('option');
                option2.value = clase.id;
                option2.textContent = `${clase.nombre} (${clase.codigo})`;
                claseEquipo.appendChild(option2);
            });
            
            // Si hay una clase pre-seleccionada, establecerla
            if (claseSeleccionada) {
                console.log('üéØ Aplicando selecci√≥n autom√°tica de clase:', claseSeleccionada);
                selectorClase.value = claseSeleccionada;
                
                // NUEVO: Tambi√©n pre-seleccionar en el modal de crear equipo
                claseEquipo.value = claseSeleccionada;
                
                // Activar el cambio autom√°ticamente
                actualizarInfoClaseActual();
            }
            
            console.log('üîç Opciones finales en selector:', selectorClase.children.length);
        }

        function cambiarClase() {
            const selector = document.getElementById('selectorClase');
            claseSeleccionada = selector.value || null;
            
            console.log('üîç DEBUG - cambiarClase():', {
                selectorValue: selector.value,
                claseSeleccionada: claseSeleccionada,
                clasesDisponibles: clasesDisponibles
            });
            
            actualizarInfoClaseActual();
            cargarEquipos();
        }

        function actualizarInfoClaseActual() {
            const infoElement = document.getElementById('claseActualInfo');
            
            if (claseSeleccionada) {
                const clase = clasesDisponibles.find(c => c.id === claseSeleccionada);
                if (clase) {
                    infoElement.textContent = `üìö ${clase.nombre}`;
                    infoElement.style.display = 'inline';
                } else {
                    infoElement.style.display = 'none';
                }
            } else {
                if (userRole === 'profesor') {
                    infoElement.textContent = 'üåê Todos los equipos';
                } else {
                    infoElement.textContent = 'üîç Equipos disponibles';
                }
                infoElement.style.display = 'inline';
            }
        }

        function configurarEventos() {
            document.getElementById('form-crear-equipo').addEventListener('submit', async (e) => {
                e.preventDefault();
                await crearEquipo();
            });

            document.getElementById('form-puntos').addEventListener('submit', async (e) => {
                e.preventDefault();
                await gestionarPuntos();
            });
            
            // NUEVO: Cambio autom√°tico al seleccionar clase
            document.getElementById('selectorClase').addEventListener('change', function() {
                console.log('üîç Selector de clase cambiado autom√°ticamente');
                cambiarClase();
            });
        }

        async function cargarEquipos() {
            try {
                const token = localStorage.getItem('classcraft_token');
                
                // USAR RUTAS V2 para soporte equipos por clase
                let url = '/api/equipos/v2';
                const params = new URLSearchParams();
                
                console.log('üîç DEBUG cargarEquipos - claseSeleccionada:', claseSeleccionada);
                
                if (claseSeleccionada) {
                    params.append('clase_id', claseSeleccionada);
                }
                
                if (params.toString()) {
                    url += '?' + params.toString();
                }
                
                console.log('üîç DEBUG cargarEquipos - URL final:', url);
                
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Error al cargar equipos');
                }

                const data = await response.json();
                
                console.log('üîç DEBUG cargarEquipos - Response:', data);
                
                equipos = data.equipos;
                
                // Mostrar mensaje informativo si existe
                if (data.mensaje) {
                    console.log('üìù Filtros aplicados:', data.mensaje);
                }
                
                mostrarEquipos(equipos);

            } catch (error) {
                console.error('Error:', error);
                alert('Error al cargar equipos: ' + error.message);
            }
        }

        function mostrarEquipos(equiposList) {
            const grid = document.getElementById('equipos-grid');
            grid.innerHTML = '';
            
            console.log('üîç DEBUG mostrarEquipos - Equipos recibidos:', equiposList.length, equiposList);

            if (equiposList.length === 0) {
                grid.innerHTML = '<p class="empty-state">‚öîÔ∏è No hay equipos disponibles</p>';
                return;
            }

            equiposList.forEach(equipo => {
                const equipoCard = crearTarjetaEquipo(equipo);
                grid.appendChild(equipoCard);
            });
        }

        function crearTarjetaEquipo(equipo) {
            
            const div = document.createElement('div');
            div.className = 'equipo-card';
            
            // Determinar acciones seg√∫n rol y tipo de equipo
            let accionesHTML = '';
            if (userRole === 'profesor') {
                accionesHTML = `
                    <button onclick="gestionarPuntosEquipo('${equipo.id || equipo._id}')" class="btn btn-sm btn-warning">üí∞ Puntos</button>
                    <button onclick="eliminarEquipo('${equipo.id || equipo._id}', '${equipo.nombre}')" class="btn btn-sm btn-danger">üóëÔ∏è Eliminar</button>
                `;
            } else if (equipo.puede_unirse && equipo.espacios_disponibles > 0) {
                accionesHTML = `<button onclick="unirseAEquipo('${equipo.id || equipo._id}')" class="btn btn-sm btn-success">‚ûï Unirse</button>`;
            } else if (equipo.espacios_disponibles === 0) {
                accionesHTML = `<span class="badge badge-warning">Equipo lleno</span>`;
            } else {
                accionesHTML = `<span class="badge badge-info">Ver equipo</span>`;
            }
            
            // Informaci√≥n de clase/tipo
            let tipoEquipoHTML = '';
            if (equipo.clase_info) {
                tipoEquipoHTML = `
                    <div class="equipo-tipo" style="margin: 8px 0;">
                        <span class="badge badge-primary">üè∑Ô∏è ${equipo.clase_info.nombre}</span>
                    </div>
                `;
            } else {
                tipoEquipoHTML = `
                    <div class="equipo-tipo" style="margin: 8px 0;">
                        <span class="badge badge-secondary">üåê Equipo Global</span>
                    </div>
                `;
            }

            div.innerHTML = `
                <div class="equipo-header">
                    <h4>${equipo.nombre}</h4>
                    <span class="profesor">üë®‚Äçüè´ ${equipo.profesor_info?.nombre || 'Profesor'}</span>
                </div>
                ${tipoEquipoHTML}
                <div class="equipo-stats">
                    <div class="stat">
                        <span class="label">üë• Miembros:</span>
                        <span class="value">${equipo.cantidad_miembros}/4</span>
                    </div>
                    <div class="stat">
                        <span class="label">üèÜ Puntos:</span>
                        <span class="value">${equipo.puntos}</span>
                    </div>
                </div>
                <div class="equipo-miembros">
                    ${equipo.miembros.slice(0, 3).map(miembro => 
                        `<span class="miembro">${miembro.nombre}</span>`
                    ).join('')}
                    ${equipo.miembros.length > 3 ? `<span class="miembro-extra">+${equipo.miembros.length - 3} m√°s</span>` : ''}
                </div>
                <div class="equipo-actions">
                    ${accionesHTML}
                </div>
            `;

            return div;
        }

        async function verificarEquipoEstudiante() {
            try {
                const token = localStorage.getItem('classcraft_token');
                // USAR RUTA V2 para ver todos los equipos del estudiante
                const response = await fetch('/api/equipos/mis-equipos-v2', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const data = await response.json();
                
                console.log('üîç DEBUG - verificarEquipoEstudiante response:', data);
                
                if (data.equipos && data.equipos.length > 0) {
                    // Mostrar el primer equipo o un resumen
                    console.log('üîç Equipos encontrados:', data.equipos.length);
                    const primerEquipo = data.equipos[0];
                    mostrarInfoMisEquipos(data.equipos);
                    document.getElementById('btn-salir-equipo').style.display = 'none'; // SIEMPRE OCULTAR bot√≥n legacy
                } else {
                    document.getElementById('mi-equipo-info').innerHTML = 
                        '<p class="no-equipo">üö´ No perteneces a ning√∫n equipo</p>';
                }

            } catch (error) {
                console.error('Error al verificar equipo:', error);
                document.getElementById('mi-equipo-info').innerHTML = 
                    '<p class="no-equipo">‚ùå Error al cargar equipos</p>';
                document.getElementById('btn-salir-equipo').style.display = 'none';
            }
        }

        function mostrarInfoMisEquipos(equipos) {
            const container = document.getElementById('mi-equipo-info');
            
            if (equipos.length === 1) {
                // Un solo equipo - mostrar con el mismo estilo que m√∫ltiples equipos
                const equipo = equipos[0];
                container.innerHTML = `
                    <div class="mis-equipos-resumen">
                        <h4>üèÜ Mi Equipo</h4>
                        <div class="equipos-lista-mini">
                            <div class="equipo-item">
                                <div class="equipo-info">
                                    <div class="equipo-nombre">${equipo.nombre}</div>
                                    <div class="equipo-detalles">
                                        <span class="clase-tag">${equipo.clase_info ? `üè∑Ô∏è ${equipo.clase_info.nombre}` : 'üåê Global'}</span>
                                        <span class="puntos-tag">üèÜ ${equipo.puntos}pts</span>
                                        <span class="miembros-tag">üë• ${equipo.miembros}/4</span>
                                    </div>
                                </div>
                                <div class="equipo-acciones">
                                    <button onclick="salirDeEquipoEspecifico('${equipo.id}', '${equipo.clase_info ? equipo.clase_info.id : ''}')" class="btn btn-xs btn-danger">üö™ Salir</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                // M√∫ltiples equipos - mostrar lista mejorada
                container.innerHTML = `
                    <div class="mis-equipos-resumen">
                        <h4>üèÜ Mis Equipos (${equipos.length})</h4>
                        <div class="equipos-lista-mini">
                            ${equipos.map(equipo => `
                                <div class="equipo-item">
                                    <div class="equipo-info">
                                        <div class="equipo-nombre">${equipo.nombre}</div>
                                        <div class="equipo-detalles">
                                            <span class="clase-tag">${equipo.clase_info ? `üè∑Ô∏è ${equipo.clase_info.nombre}` : 'üåê Global'}</span>
                                            <span class="puntos-tag">üèÜ ${equipo.puntos}pts</span>
                                            <span class="miembros-tag">üë• ${equipo.miembros}/4</span>
                                        </div>
                                    </div>
                                    <div class="equipo-acciones">
                                        <button onclick="salirDeEquipoEspecifico('${equipo.id}', '${equipo.clase_info ? equipo.clase_info.id : ''}')" class="btn btn-xs btn-danger">üö™</button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
        }

        function mostrarCrearEquipo() {
            document.getElementById('modal-crear-equipo').style.display = 'flex';
        }

        async function crearEquipo() {
            try {
                const token = localStorage.getItem('classcraft_token');
                const formData = {
                    nombre: document.getElementById('nombre-equipo').value,
                    color_equipo: document.getElementById('color-equipo').value
                };
                
                // Agregar clase_id si se seleccion√≥ una clase
                const claseSeleccionada = document.getElementById('clase-equipo').value;
                if (claseSeleccionada) {
                    formData.clase_id = claseSeleccionada;
                }

                const response = await fetch('/api/equipos/crear', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(formData)
                });

                const result = await response.json();
                
                if (response.ok) {
                    // Mensaje m√°s informativo
                    let mensaje = `‚úÖ ${result.message}`;
                    if (result.equipo.clase_info) {
                        mensaje += ` en la clase ${result.equipo.clase_info.nombre}`;
                    } else {
                        mensaje += ` como equipo global`;
                    }
                    
                    alert(mensaje);
                    cerrarModal('modal-crear-equipo');
                    
                    // Recargar equipos
                    await cargarEquipos();
                    
                    // Limpiar formulario
                    document.getElementById('form-crear-equipo').reset();
                } else {
                    alert('‚ùå ' + result.error);
                }

            } catch (error) {
                console.error('Error:', error);
                alert('Error al crear equipo');
            }
        }

        async function unirseAEquipo(equipoId) {
            try {
                console.log('üîç Frontend - Enviando equipoId:', equipoId, 'Longitud:', equipoId.length);
                
                const token = localStorage.getItem('classcraft_token');
                // USAR RUTA V2 para soporte equipos por clase
                const response = await fetch(`/api/equipos/${equipoId}/unirse-v2`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const result = await response.json();
                
                if (response.ok) {
                    alert('‚úÖ ' + result.message);
                    verificarEquipoEstudiante();
                    cargarEquipos();
                } else {
                    alert('‚ùå ' + result.error);
                }

            } catch (error) {
                console.error('Error:', error);
                alert('Error al unirse al equipo');
            }
        }

        async function salirDeEquipo() {
            // Funci√≥n legacy - redirigir a nueva funci√≥n
            alert('üìù Usa los botones individuales para salir de equipos espec√≠ficos');
        }

        async function salirDeEquipoEspecifico(equipoId, claseId) {
            try {
                const token = localStorage.getItem('classcraft_token');
                
                console.log('üîç DEBUG - Salir de equipo:', { equipoId, claseId });
                
                // Obtener informaci√≥n del equipo para confirmaci√≥n
                const equipoInfo = await obtenerInfoEquipo(equipoId);
                if (!equipoInfo) {
                    alert('‚ùå Equipo no encontrado');
                    return;
                }
                
                const contexto = claseId && claseId !== '' ? `en la clase ${equipoInfo.clase_nombre}` : 'global';
                if (!confirm(`¬øEst√°s seguro de que quieres salir del equipo "${equipoInfo.nombre}" ${contexto}?`)) {
                    return;
                }

                // Preparar datos para salir - SOLO enviar clase_id si no est√° vac√≠o
                const requestBody = (claseId && claseId !== '') ? { clase_id: claseId } : {};
                
                console.log('üîç REQUEST BODY:', requestBody);
                
                const response = await fetch('/api/equipos/salir-v2', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(requestBody)
                });

                const result = await response.json();
                
                console.log('üîç RESPONSE:', result);
                
                if (response.ok) {
                    alert('‚úÖ ' + result.message);
                    await verificarEquipoEstudiante();
                    await cargarEquipos();
                } else {
                    console.error('‚ùå Error del servidor:', result);
                    alert('‚ùå ' + result.error);
                }

            } catch (error) {
                console.error('‚ùå Error en salirDeEquipoEspecifico:', error);
                alert('Error al salir del equipo: ' + error.message);
            }
        }

        async function obtenerInfoEquipo(equipoId) {
            try {
                const token = localStorage.getItem('classcraft_token');
                const response = await fetch('/api/equipos/v2', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const data = await response.json();
                const equipo = data.equipos.find(e => e.id === equipoId || e._id === equipoId);
                
                if (equipo) {
                    return {
                        nombre: equipo.nombre,
                        clase_nombre: equipo.clase_info ? equipo.clase_info.nombre : null
                    };
                }
                return null;
            } catch (error) {
                console.error('Error obteniendo info equipo:', error);
                return null;
            }
        }

        function gestionarPuntosEquipo(equipoId) {
            const equipo = equipos.find(e => e.id === equipoId || e._id === equipoId);
            if (!equipo) return;

            document.getElementById('equipo-puntos-info').innerHTML = `
                <div class="equipo-info-puntos">
                    <h4>${equipo.nombre}</h4>
                    <p>Puntos actuales: <strong>${equipo.puntos}</strong></p>
                    <p>Miembros: ${equipo.cantidad_miembros}/4</p>
                </div>
            `;
            
            document.getElementById('form-puntos').dataset.equipoId = equipoId;
            document.getElementById('modal-puntos').style.display = 'flex';
        }

        async function gestionarPuntos() {
            try {
                const equipoId = document.getElementById('form-puntos').dataset.equipoId;
                const token = localStorage.getItem('classcraft_token');
                
                const formData = {
                    operacion: document.getElementById('operacion-puntos').value,
                    cantidad: parseInt(document.getElementById('cantidad-puntos').value),
                    razon: document.getElementById('razon-puntos').value
                };

                const response = await fetch(`/api/equipos/${equipoId}/puntos`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(formData)
                });

                const result = await response.json();
                
                if (response.ok) {
                    alert(`‚úÖ ${result.message}\nAnterior: ${result.puntos_anteriores} ‚Üí Nuevo: ${result.puntos_actuales}`);
                    cerrarModal('modal-puntos');
                    cargarEquipos();
                    document.getElementById('form-puntos').reset();
                } else {
                    alert('‚ùå ' + result.error);
                }

            } catch (error) {
                console.error('Error:', error);
                alert('Error al gestionar puntos');
            }
        }

        async function verRanking() {
            try {
                const token = localStorage.getItem('classcraft_token');
                
                // Construir URL del ranking
                let url = '/api/equipos/ranking/';
                const params = new URLSearchParams();
                
                if (claseSeleccionada) {
                    params.append('clase_id', claseSeleccionada);
                }
                
                if (params.toString()) {
                    url += '?' + params.toString();
                }
                
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Error al cargar ranking');
                }

                const data = await response.json();
                mostrarRanking(data);
                document.getElementById('modal-ranking').style.display = 'flex';

            } catch (error) {
                console.error('Error:', error);
                alert('Error al cargar ranking: ' + error.message);
            }
        }

        async function eliminarEquipo(equipoId, nombreEquipo) {
            try {
                if (!confirm(`¬øEst√°s seguro de que quieres eliminar el equipo "${nombreEquipo}"?\n\n‚ö†Ô∏è ATENCI√ìN: Esta acci√≥n es irreversible y todos los miembros ser√°n removidos del equipo.`)) {
                    return;
                }

                const token = localStorage.getItem('classcraft_token');
                const response = await fetch(`/api/equipos/${equipoId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const result = await response.json();
                
                if (response.ok) {
                    alert(`‚úÖ ${result.message}`);
                    await cargarEquipos();
                } else {
                    alert('‚ùå ' + result.error);
                }

            } catch (error) {
                console.error('Error:', error);
                alert('Error al eliminar equipo: ' + error.message);
            }
        }

        function mostrarRanking(data) {
            const container = document.getElementById('ranking-container');
            const ranking = data.ranking;
            
            if (ranking.length === 0) {
                container.innerHTML = '<p class="empty-state">üèÜ No hay equipos para rankear</p>';
                return;
            }

            // Header con informaci√≥n contextual
            let headerHTML = `
                <div class="ranking-header-info" style="margin-bottom: 20px; padding: 15px; background: #f7fafc; border-radius: 8px;">
                    <h4 style="margin: 0 0 10px 0;">${data.contexto.descripcion}</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; font-size: 0.9em;">
                        <div><strong>Total equipos:</strong> ${data.estadisticas.total_equipos}</div>
                        <div><strong>Total miembros:</strong> ${data.estadisticas.total_miembros}</div>
                        <div><strong>Puntos totales:</strong> ${data.estadisticas.puntos_totales}</div>
                    </div>`;
            
            if (data.estadisticas.equipos_con_clase > 0 && data.estadisticas.equipos_globales > 0) {
                headerHTML += `
                    <div style="margin-top: 10px; font-size: 0.85em; color: #718096;">
                        üè∑Ô∏è ${data.estadisticas.equipos_con_clase} equipos de clase | 
                        üåê ${data.estadisticas.equipos_globales} equipos globales
                    </div>`;
            }
            
            headerHTML += '</div>';

            container.innerHTML = headerHTML + `
                <div class="ranking-table">
                    <div class="ranking-header">
                        <span>Pos</span>
                        <span>Equipo</span>
                        <span>Tipo</span>
                        <span>Puntos</span>
                        <span>Miembros</span>
                    </div>
                    ${ranking.map(equipo => {
                        const medalla = equipo.posicion === 1 ? 'ü•á' : 
                                       equipo.posicion === 2 ? 'ü•à' : 
                                       equipo.posicion === 3 ? 'ü•â' : 'üèÖ';
                        
                        const tipoIcono = equipo.tipo_equipo === 'clase' ? 'üè∑Ô∏è' : 'üåê';
                        const tipoTexto = equipo.tipo_equipo === 'clase' && equipo.clase_info ? 
                            equipo.clase_info.codigo : 'Global';
                        
                        return `
                            <div class="ranking-row">
                                <span class="posicion">${medalla} ${equipo.posicion}</span>
                                <span class="nombre">${equipo.nombre}</span>
                                <span class="tipo">${tipoIcono} ${tipoTexto}</span>
                                <span class="puntos">${equipo.puntos}</span>
                                <span class="miembros">${equipo.cantidad_miembros}/4</span>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        function cerrarModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        function logout() {
            localStorage.removeItem('classcraft_token');
            localStorage.removeItem('classcraft_user');
            location.href = 'login.html';
        }

        // Cerrar modales al hacer click fuera
        window.onclick = function(event) {
            const modales = ['modal-crear-equipo', 'modal-puntos', 'modal-ranking'];
            modales.forEach(modalId => {
                const modal = document.getElementById(modalId);
                const modalContent = modal.querySelector('.modal-content');
                
                // Solo cerrar si el click es directamente en el modal (fondo), no en el contenido
                if (event.target === modal && !modalContent.contains(event.target)) {
                    cerrarModal(modalId);
                }
            });
        }
    </script>
    
    <style>
        /* Estilos adicionales para equipos por clase */
        .clase-selector-container {
            margin-bottom: 20px;
        }
        
        .form-select {
            padding: 8px 12px;
            border: 1px solid #e2e8f0;
            border-radius: 4px;
            background: white;
            font-size: 0.9em;
        }
        
        .form-help {
            display: block;
            margin-top: 4px;
            font-size: 0.8em;
            color: #718096;
        }
        
        .badge {
            display: inline-block;
            padding: 4px 8px;
            font-size: 0.75em;
            font-weight: 600;
            border-radius: 4px;
            text-transform: uppercase;
        }
        
        .badge-primary {
            background: #4299e1;
            color: white;
        }
        
        .badge-secondary {
            background: #a0aec0;
            color: white;
        }
        
        .badge-info {
            background: #63b3ed;
            color: white;
        }
        
        .badge-warning {
            background: #f6ad55;
            color: white;
        }
        
        .equipo-tipo {
            text-align: center;
        }
        
        .miembro-extra {
            font-style: italic;
            color: #718096;
            font-size: 0.85em;
        }
        
        .ranking-header-info {
            border: 1px solid #e2e8f0;
        }
        
        .ranking-table .ranking-header {
            display: grid;
            grid-template-columns: 60px 1fr 80px 80px 80px;
            gap: 10px;
            font-weight: bold;
            padding: 10px;
            background: #edf2f7;
            border-radius: 4px;
        }
        
        .ranking-table .ranking-row {
            display: grid;
            grid-template-columns: 60px 1fr 80px 80px 80px;
            gap: 10px;
            padding: 10px;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .ranking-row:hover {
            background: #f7fafc;
        }
        
        .btn-sm {
            padding: 6px 12px;
            font-size: 0.85em;
        }
        
        /* Nuevos estilos para cards de equipos m√°s limpias */
        .equipos-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            padding: 0;
            margin-top: 20px;
        }
        
        .equipos-lista {
            position: relative;
            z-index: 1;
        }
        
        .equipos-header {
            margin-bottom: 20px;
            z-index: 2;
            position: relative;
        }
        
        .equipo-card {
            background: rgba(245, 235, 215, 0.85);
            border: 2px solid rgba(205, 133, 63, 0.3);
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s ease;
            position: relative;
            backdrop-filter: blur(5px);
        }
        
        .equipo-card:hover {
            border-color: #CD853F;
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(139, 69, 19, 0.2);
            z-index: 3;
            position: relative;
        }
        
        .equipo-header {
            margin-bottom: 15px;
        }
        
        .equipo-header h4 {
            color: #2F1B14;
            font-size: 1.3em;
            margin: 0 0 8px 0;
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(139, 69, 19, 0.2);
        }
        
        .equipo-header .profesor {
            color: #8B4513;
            font-size: 0.9em;
            opacity: 0.8;
        }
        
        .equipo-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin: 15px 0;
        }
        
        .equipo-stats .stat {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: rgba(245, 235, 215, 0.4);
            border-radius: 8px;
            border: 1px solid rgba(205, 133, 63, 0.2);
        }
        
        .equipo-stats .stat .label {
            color: #8B4513;
            font-size: 0.9em;
        }
        
        .equipo-stats .stat .value {
            color: #2F1B14;
            font-weight: bold;
            font-size: 1.1em;
        }
        
        .equipo-miembros {
            margin: 15px 0;
        }
        
        .equipo-miembros .miembro {
            display: inline-block;
            background: rgba(210, 105, 30, 0.1);
            color: #8B4513;
            padding: 4px 8px;
            margin: 2px 4px 2px 0;
            border-radius: 12px;
            font-size: 0.85em;
            border: 1px solid rgba(210, 105, 30, 0.2);
        }
        
        .equipo-actions {
            text-align: center;
            margin-top: 15px;
            display: flex;
            gap: 8px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .equipo-actions .btn {
            min-width: 100px;
            flex: 1;
        }
        
        .equipo-actions .btn-sm {
            min-width: 80px;
            padding: 6px 10px;
            font-size: 0.8em;
        }
        
        .empty-state {
            text-align: center;
            color: #2F1B14;
            font-size: 1.1em;
            padding: 40px 20px;
            background: rgba(245, 235, 215, 0.95);
            border: 4px solid #CD853F;
            border-radius: 15px;
            margin: 20px 0;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        }
        
        /* Badges mejorados */
        .badge {
            font-weight: 600;
            letter-spacing: 0.5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .badge-primary {
            background: linear-gradient(135deg, #4299e1 0%, #3182ce 100%);
        }
        
        .badge-secondary {
            background: linear-gradient(135deg, #a0aec0 0%, #718096 100%);
        }
        
        /* Estilos para m√∫ltiples equipos V2 */
        .mis-equipos-resumen {
            background: rgba(245, 235, 215, 0.9);
            border: 1px solid #CD853F;
            border-radius: 8px;
            padding: 15px;
        }
        
        .equipo-mini {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid rgba(205, 133, 63, 0.2);
        }
        
        .equipo-mini:last-child {
            border-bottom: none;
        }
        
        .equipo-mini .nombre {
            font-weight: bold;
            color: #2F1B14;
        }
        
        .equipo-mini .clase {
            font-size: 0.85em;
            color: #8B4513;
            background: rgba(210, 105, 30, 0.1);
            padding: 2px 6px;
            border-radius: 4px;
        }
        
        .equipo-mini .puntos {
            font-weight: bold;
            color: #DAA520;
        }
        
        .clase-info {
            margin-top: 8px;
            font-size: 0.85em;
            color: #8B4513;
            padding: 4px 8px;
            background: rgba(210, 105, 30, 0.1);
            border-radius: 4px;
            text-align: center;
        }
        
        /* Estilos mejorados para m√∫ltiples equipos */
        .equipos-lista-mini {
            margin-top: 15px;
        }
        
        .equipo-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            margin-bottom: 10px;
            background: rgba(245, 235, 215, 0.7);
            border: 1px solid rgba(205, 133, 63, 0.3);
            border-radius: 8px;
            transition: all 0.2s ease;
        }
        
        .equipo-item:hover {
            background: rgba(245, 235, 215, 0.9);
            border-color: #CD853F;
            transform: translateX(3px);
        }
        
        .equipo-item:last-child {
            margin-bottom: 0;
        }
        
        .equipo-info {
            flex: 1;
        }
        
        .equipo-nombre {
            font-weight: bold;
            color: #2F1B14;
            font-size: 1.1em;
            margin-bottom: 6px;
        }
        
        .equipo-detalles {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .clase-tag, .puntos-tag, .miembros-tag {
            font-size: 0.8em;
            padding: 3px 8px;
            border-radius: 12px;
            font-weight: 600;
        }
        
        .clase-tag {
            background: rgba(66, 153, 225, 0.2);
            color: #2B6CB0;
            border: 1px solid rgba(66, 153, 225, 0.3);
        }
        
        .puntos-tag {
            background: rgba(218, 165, 32, 0.2);
            color: #B7791F;
            border: 1px solid rgba(218, 165, 32, 0.3);
        }
        
        .miembros-tag {
            background: rgba(72, 187, 120, 0.2);
            color: #2F855A;
            border: 1px solid rgba(72, 187, 120, 0.3);
        }
        
        .equipo-acciones {
            margin-left: 15px;
        }
        
        .btn-xs {
            padding: 4px 8px;
            font-size: 0.75em;
            border-radius: 4px;
            min-width: auto;
        }
        
        .btn-xs:hover {
            transform: scale(1.1);
        }
        
        /* Estilos para secci√≥n de tips */
        .tips-section {
            margin: 30px 0;
        }
        
        .tips-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .tip-card {
            background: rgba(222, 184, 135, 0.6);
            border: 2px solid rgba(205, 133, 63, 0.4);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s ease;
        }
        
        .tip-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(139, 69, 19, 0.3);
            border-color: #CD853F;
        }
        
        .tip-icon {
            font-size: 2.5em;
            display: block;
            margin-bottom: 15px;
            filter: drop-shadow(2px 2px 4px rgba(0,0,0,0.3));
        }
        
        .tip-card h4 {
            color: #2F1B14;
            margin-bottom: 10px;
            font-size: 1.2em;
        }
        
        .tip-card p {
            color: #8B4513;
            line-height: 1.5;
            margin: 0;
        }
    </style>
</body>
</html>