<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ClassCraft - P√°gina DEV</title>
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
    <div class="header">
        <div class="header-content container">
            <div class="logo-section">
                <img src="/images/LOGO.png" alt="ClassCraft" class="main-logo" style="max-width: 250px; margin-left: 80px;">
            </div>
            <div class="auth-buttons">
                <a href="/dashboard.html" class="btn btn-secondary">Dashboard</a>
                <a href="/login.html" class="btn btn-primary">Login</a>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="nav">
            <a href="/dashboard.html">üè† Dashboard</a>
            <a href="/login.html">üîë Login</a>
            <a href="/register.html">üìù Register</a>
            <a href="/dev.html">üîß DEV</a>
        </div>

        <div class="dev-warning">
            ‚ö†Ô∏è CUIDADO: Esta p√°gina es solo para desarrollo. Las acciones aqu√≠ pueden borrar datos permanentemente.
        </div>

        <div class="card dev-section">
            <h2>üóÑÔ∏è Base de Datos</h2>
            
            <div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 8px; margin: 20px 0;">
                <h4 style="color: white; margin-bottom: 15px;">üìä Estado Actual</h4>
                <div id="dbStats">
                    <div class="loading" style="color: white;">Cargando stats...</div>
                </div>
                
                <button class="btn btn-secondary" onclick="loadDbStats()" style="margin-top: 15px;">
                    üîÑ Actualizar Stats
                </button>
            </div>

            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                <button class="btn btn-dev btn-full" onclick="resetDatabase()">
                    üîÑ Reset Completo (Seeds)
                </button>
                
                <button class="btn btn-danger btn-full" onclick="clearAllData()">
                    üóëÔ∏è Borrar TODO
                </button>
                
                <button class="btn btn-dev btn-full" onclick="createTestUsers()">
                    üë• Crear Usuarios Test
                </button>
                
                <button class="btn btn-dev btn-full" onclick="clearTokens()">
                    üßπ Limpiar Tokens
                </button>
            </div>
        </div>

        <div class="card">
            <h2>üß™ Testing R√°pido</h2>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
                <button class="btn btn-secondary" onclick="testLogin()">
                    üîë Test Login
                </button>
                
                <button class="btn btn-secondary" onclick="testPersonaje()">
                    ‚öîÔ∏è Test Personaje
                </button>
                
                <button class="btn btn-secondary" onclick="testClases()">
                    üè´ Test Clases
                </button>
                
                <button class="btn btn-secondary" onclick="testHabilidades()">
                    üîÆ Test Habilidades
                </button>
            </div>

            <div id="testResults" style="margin-top: 20px;">
                <!-- Resultados de tests aparecer√°n aqu√≠ -->
            </div>
        </div>

        <div class="card">
            <h2>üìã Datos de Desarrollo</h2>
            
            <div style="background: #f7fafc; padding: 15px; border-radius: 8px;">
                <h4>üë§ Credenciales de Prueba</h4>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 10px;">
                    <div>
                        <strong>Profesor:</strong><br>
                        Email: profesor@test.com<br>
                        Password: 123456
                    </div>
                    <div>
                        <strong>Estudiantes:</strong><br>
                        ana@test.com / 123456<br>
                        carlos@test.com / 123456<br>
                        maria@test.com / 123456<br>
                        pedro@test.com / 123456
                    </div>
                </div>
            </div>

            <div style="background: #e6fffa; padding: 15px; border-radius: 8px; margin-top: 15px;">
                <h4>üîó URLs Importantes</h4>
                <ul style="margin-left: 20px;">
                    <li><a href="http://localhost:3000" target="_blank">API Base</a></li>
                    <li><a href="http://localhost:3000/api/test" target="_blank">Test Modelos</a></li>
                    <li><a href="http://localhost:3000/api/setup" target="_blank">Setup Seeds</a></li>
                    <li><a href="/login.html">Login Frontend</a></li>
                    <li><a href="/dashboard.html">Dashboard</a></li>
                </ul>
            </div>
        </div>

        <div class="card">
            <h2>üîç API Explorer</h2>
            
            <div style="background: #f7fafc; padding: 15px; border-radius: 8px;">
                <h4>Endpoints Disponibles:</h4>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 10px; margin-top: 10px; font-family: monospace; font-size: 12px;">
                    <div>
                        <strong>Auth:</strong><br>
                        POST /api/auth/register<br>
                        POST /api/auth/login<br>
                        GET /api/auth/profile
                    </div>
                    <div>
                        <strong>Personajes:</strong><br>
                        GET /api/personajes/mi-personaje<br>
                        POST /api/personajes/crear<br>
                        POST /api/personajes/usar-habilidad
                    </div>
                    <div>
                        <strong>Clases:</strong><br>
                        POST /api/clases/crear<br>
                        POST /api/clases/unirse/:codigo<br>
                        GET /api/clases/mis-clases
                    </div>
                    <div>
                        <strong>Datos:</strong><br>
                        GET /api/clases-personaje<br>
                        GET /api/razas<br>
                        GET /api/habilidades
                    </div>
                </div>
            </div>
        </div>
    </div>

    <footer class="epic-footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <h3>ClassCraft</h3>
                    <p>Transformando la educaci√≥n a trav√©s de la gamificaci√≥n y aventuras √©picas en el aula.</p>
                </div>
                <div class="footer-section">
                    <h3>Recursos</h3>
                    <ul class="footer-links">
                        <li><a href="#">Gu√≠a del Profesor</a></li>
                        <li><a href="#">Manual del Estudiante</a></li>
                        <li><a href="#">Habilidades & Clases</a></li>
                        <li><a href="#">Sistema de Puntos</a></li>
                    </ul>
                </div>
                <div class="footer-section">
                    <h3>Soporte</h3>
                    <ul class="footer-links">
                        <li><a href="#">Centro de Ayuda</a></li>
                        <li><a href="#">Reportar Bug</a></li>
                        <li><a href="#">Sugerir Mejora</a></li>
                        <li><a href="#">Contacto</a></li>
                    </ul>
                </div>
                <div class="footer-section">
                    <h3>Comunidad</h3>
                    <div class="social-links">
                        <a href="#" class="social-link">
                            <span class="social-icon">üìò</span> Facebook
                        </a>
                        <a href="#" class="social-link">
                            <span class="social-icon">üê¶</span> Twitter
                        </a>
                        <a href="#" class="social-link">
                            <span class="social-icon">üì∑</span> Instagram
                        </a>
                    </div>
                </div>
            </div>
            <div class="footer-bottom">
                <div class="credits">
                    <p>Desarrollado con ‚ù§Ô∏è por <strong>Rafael Inga Tello</strong></p>
                    <p class="tech-stack">Node.js ‚Ä¢ MongoDB ‚Ä¢ Express ‚Ä¢ Vanilla JS</p>
                </div>
                <div class="footer-logo">
                    <div class="mini-logo">Class<span>Craft</span></div>
                </div>
            </div>
        </div>
    </footer>

    <script src="/js/app.js"></script>
    <script>
        // Cargar stats de la BD al cargar la p√°gina
        document.addEventListener('DOMContentLoaded', () => {
            loadDbStats();
        });

        // Cargar estad√≠sticas de la base de datos
        async function loadDbStats() {
            try {
                const stats = await getDbStats();
                const dbStatsElement = document.getElementById('dbStats');
                
                dbStatsElement.innerHTML = `
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px;">
                        <div style="color: white; text-align: center;">
                            <div style="font-size: 1.5em; font-weight: bold;">${stats.database_stats.usuarios}</div>
                            <div style="font-size: 0.9em;">Usuarios</div>
                        </div>
                        <div style="color: white; text-align: center;">
                            <div style="font-size: 1.5em; font-weight: bold;">${stats.database_stats.personajes}</div>
                            <div style="font-size: 0.9em;">Personajes</div>
                        </div>
                        <div style="color: white; text-align: center;">
                            <div style="font-size: 1.5em; font-weight: bold;">${stats.database_stats.clases}</div>
                            <div style="font-size: 0.9em;">Clases</div>
                        </div>
                        <div style="color: white; text-align: center;">
                            <div style="font-size: 1.5em; font-weight: bold;">${stats.database_stats.habilidades}</div>
                            <div style="font-size: 0.9em;">Habilidades</div>
                        </div>
                    </div>
                    <div style="color: white; text-align: center; margin-top: 15px;">
                        <strong>MongoDB Status:</strong> ${stats.mongodb_status}
                    </div>
                `;
            } catch (error) {
                document.getElementById('dbStats').innerHTML = `
                    <div style="color: #ff6b6b; text-align: center;">
                        Error cargando stats: ${error.message}
                    </div>
                `;
            }
        }

        // Reset completo de la base de datos
        async function resetDatabase() {
            if (!confirm('¬øEst√°s seguro? Esto recrear√° todos los datos con los seeds originales.')) {
                return;
            }
            
            try {
                showAlert('Reseteando base de datos...', 'info');
                const response = await resetDatabase();
                showAlert('Base de datos reseteada exitosamente!', 'success');
                await loadDbStats();
                
                // Limpiar tokens locales
                clearAuth();
                
            } catch (error) {
                showAlert('Error reseteando BD: ' + error.message, 'error');
            }
        }

        // Borrar TODOS los datos
        async function clearAllData() {
            if (!confirm('‚ö†Ô∏è PELIGRO: Esto borrar√° TODOS los datos sin posibilidad de recuperaci√≥n. ¬øContinuar?')) {
                return;
            }
            
            if (!confirm('¬øEst√°s absolutamente seguro? Esta acci√≥n es IRREVERSIBLE.')) {
                return;
            }
            
            try {
                showAlert('Borrando todos los datos...', 'info');
                
                // Llamar a un endpoint especial para borrar todo
                await apiRequest('/dev/clear-all', {
                    method: 'POST'
                });
                
                showAlert('Todos los datos han sido borrados!', 'success');
                await loadDbStats();
                
                // Limpiar tokens locales
                clearAuth();
                
            } catch (error) {
                showAlert('Error: ' + error.message, 'error');
            }
        }

        // Crear usuarios de prueba r√°pidos
        async function createTestUsers() {
            try {
                showAlert('Creando usuarios de prueba...', 'info');
                
                const testUsers = [
                    { nombre: 'Test Student 1', email: 'test1@example.com', password: '123456', rol: 'estudiante' },
                    { nombre: 'Test Student 2', email: 'test2@example.com', password: '123456', rol: 'estudiante' },
                    { nombre: 'Test Professor', email: 'prof@example.com', password: '123456', rol: 'profesor' }
                ];
                
                for (const user of testUsers) {
                    try {
                        await register(user.nombre, user.email, user.password, user.rol);
                    } catch (error) {
                        // Ignorar si el usuario ya existe
                    }
                }
                
                showAlert('Usuarios de prueba creados!', 'success');
                await loadDbStats();
                
            } catch (error) {
                showAlert('Error creando usuarios: ' + error.message, 'error');
            }
        }

        // Limpiar tokens del localStorage
        function clearTokens() {
            clearAuth();
            showAlert('Tokens limpiados del localStorage', 'success');
        }

        // TESTS R√ÅPIDOS
        async function testLogin() {
            const resultsDiv = document.getElementById('testResults');
            resultsDiv.innerHTML = '<div class="loading">Ejecutando test de login...</div>';
            
            try {
                // Test login con credenciales v√°lidas
                const response = await login('profesor@test.com', '123456');
                
                resultsDiv.innerHTML = `
                    <div class="alert alert-success">
                        <h4>‚úÖ Test Login EXITOSO</h4>
                        <p><strong>Usuario:</strong> ${response.usuario.nombre}</p>
                        <p><strong>Rol:</strong> ${response.usuario.rol}</p>
                        <p><strong>Token generado:</strong> ${response.token ? 'S√≠' : 'No'}</p>
                    </div>
                `;
                
            } catch (error) {
                resultsDiv.innerHTML = `
                    <div class="alert alert-error">
                        <h4>‚ùå Test Login FALL√ì</h4>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        async function testPersonaje() {
            const resultsDiv = document.getElementById('testResults');
            resultsDiv.innerHTML = '<div class="loading">Ejecutando test de personaje...</div>';
            
            try {
                // Asegurar que estamos logueados
                if (!authToken) {
                    await login('ana@test.com', '123456');
                }
                
                const personajeData = await getMyPersonaje();
                
                resultsDiv.innerHTML = `
                    <div class="alert alert-success">
                        <h4>‚úÖ Test Personaje EXITOSO</h4>
                        <p><strong>Personaje:</strong> ${personajeData.personaje.clase_personaje_id.nombre} ${personajeData.personaje.raza_id.nombre}</p>
                        <p><strong>Nivel:</strong> ${personajeData.personaje.nivel}</p>
                        <p><strong>Salud:</strong> ${personajeData.personaje.salud_actual}/${personajeData.personaje.salud_maxima}</p>
                        <p><strong>Habilidades disponibles:</strong> ${personajeData.habilidades_disponibles.length}</p>
                    </div>
                `;
                
            } catch (error) {
                resultsDiv.innerHTML = `
                    <div class="alert alert-error">
                        <h4>‚ùå Test Personaje FALL√ì</h4>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        async function testClases() {
            const resultsDiv = document.getElementById('testResults');
            resultsDiv.innerHTML = '<div class="loading">Ejecutando test de clases...</div>';
            
            try {
                // Test como profesor
                await login('profesor@test.com', '123456');
                const clasesData = await getMyClases();
                
                resultsDiv.innerHTML = `
                    <div class="alert alert-success">
                        <h4>‚úÖ Test Clases EXITOSO</h4>
                        <p><strong>Clases del profesor:</strong> ${clasesData.clases.length}</p>
                        ${clasesData.clases.map(clase => `
                            <p>‚Ä¢ ${clase.nombre} (${clase.codigo}) - ${clase.estudiantes_count} estudiantes</p>
                        `).join('')}
                    </div>
                `;
                
            } catch (error) {
                resultsDiv.innerHTML = `
                    <div class="alert alert-error">
                        <h4>‚ùå Test Clases FALL√ì</h4>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        async function testHabilidades() {
            const resultsDiv = document.getElementById('testResults');
            resultsDiv.innerHTML = '<div class="loading">Ejecutando test de habilidades...</div>';
            
            try {
                const habilidades = await getHabilidades();
                
                const generales = habilidades.filter(h => h.es_general);
                const especificas = habilidades.filter(h => !h.es_general);
                
                resultsDiv.innerHTML = `
                    <div class="alert alert-success">
                        <h4>‚úÖ Test Habilidades EXITOSO</h4>
                        <p><strong>Habilidades generales:</strong> ${generales.length}</p>
                        <p><strong>Habilidades espec√≠ficas:</strong> ${especificas.length}</p>
                        <p><strong>Total:</strong> ${habilidades.length}</p>
                        <details style="margin-top: 10px;">
                            <summary>Ver lista completa</summary>
                            <ul style="margin-top: 10px;">
                                ${habilidades.map(h => `
                                    <li>${h.nombre} (${h.es_general ? 'General' : h.clases_permitidas.join(', ')}) - ${h.costo_energia} energ√≠a</li>
                                `).join('')}
                            </ul>
                        </details>
                    </div>
                `;
                
            } catch (error) {
                resultsDiv.innerHTML = `
                    <div class="alert alert-error">
                        <h4>‚ùå Test Habilidades FALL√ì</h4>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }
    </script>
</body>
</html>
